# 탄중포 (Tanjoongpo)

> 회원 데이터와 렌탈 정보를 매칭하여 적립 데이터를 생성하는 자동화 스크립트

---

## 개요

탄중포는 매일 새벽 2시에 자동으로 실행되어 다음 작업을 수행합니다:

1. SFTP 서버에서 회원(MBR) 정보를 가져옴
2. MySQL 데이터베이스에서 당일 렌탈 데이터를 조회
3. DuckDB를 활용하여 두 데이터를 매칭
4. 적립(ACR) 결과를 JSON 형식으로 생성
5. SFTP 서버로 결과 파일 전송

---

## 기술 스택

| 도구 | 용도 |
|------|------|
| **Bash** | 메인 스크립트 |
| **DuckDB** | 데이터 처리 및 MySQL 연결 |
| **jq** | JSON 파싱 |
| **Cron** | 스케줄링 |

---

## 프로젝트 구조

```
tanjongpo/
├── tanjoongpo.sh    # 메인 실행 스크립트
├── init.sh          # 환경 설정 스크립트
├── cronjobs         # 크론탭 설정
└── README.md
```

---

## 설치

### 1. 의존성 설치

```bash
sh init.sh
```

위 명령어로 다음 도구들이 설치됩니다:
- `jq` - JSON 처리
- `cronie` - 크론잡 스케줄러
- `duckdb` - 데이터 분석 엔진

### 2. 크론탭 등록

```bash
crontab cronjobs
```

---

## 사용법

### 수동 실행

```bash
sh tanjoongpo.sh
```

### 크론잡 확인

```bash
crontab -l
```

> 기본 설정: 매일 새벽 2시 실행 (`0 2 * * *`)

---

## 데이터 흐름

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  SFTP 서버  │────▶│   DuckDB    │◀────│   MySQL    │
│  (MBR 정보) │     │  (데이터 매칭)  │     │ (렌탈 정보) │
└─────────────┘     └──────┬──────┘     └─────────────┘
                           │
                           ▼
                   ┌─────────────┐
                   │  SFTP 서버  │
                   │  (ACR 결과) │
                   └─────────────┘
```

---

## 출력 파일 형식

### ACR (적립 결과) JSON

```json
{
  "info": {
    "requestNo": "001",
    "partcptnEntCd": "E0960",
    "rlvtDe": "20251223",
    "nextMthd": "F",
    "encptCd": "PT",
    "totcnt": "10",
    "errCd": "E000"
  },
  "acrs": [
    {
      "mtchgId": "...",
      "incntvCd": "I0003",
      "acrsCo": 1,
      "dtlAcrs": 0
    }
  ]
}
```

---

## 로그

실행 시 `YYYYMMDD.log` 형식의 로그 파일이 생성됩니다.

```
[2025-12-23 02:00:00] 탄중포 오늘의 작업 시작
[2025-12-23 02:00:01] mbr_info 가져오기
[2025-12-23 02:00:02] DUCKDB: MBR 테이블 생성 시작
...
```

---

## 라이선스

Private
